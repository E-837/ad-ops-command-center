<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Ad Ops Command Center</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <nav class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ“Š Ad Ops</h1>
      <span class="subtitle">Command Center</span>
    </div>
    <ul class="nav-links">
      <li><a href="/dashboard" class="nav-link active">ğŸ“ˆ Dashboard</a></li>
      <li><a href="/campaigns" class="nav-link">ğŸ“‹ Campaigns</a></li>
      <li><a href="/insights" class="nav-link">ğŸ’¡ Insights</a></li>
      <li><a href="/agents" class="nav-link">ğŸ¤– Agents</a></li>
      <li><a href="/query" class="nav-link">ğŸ’¬ Query</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <header class="page-header">
      <h2>ğŸ“ˆ Dashboard</h2>
      <p>Live pacing and performance overview</p>
    </header>

    <!-- DSP Summary Cards -->
    <section class="dsp-summary">
      <div class="summary-card glass ttd">
        <div class="card-header">
          <h3>TTD</h3>
          <span class="status-badge">Live</span>
        </div>
        <div class="card-metrics" id="ttd-metrics">
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Budget</span>
          </div>
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Spent</span>
          </div>
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Pacing</span>
          </div>
        </div>
      </div>
      
      <div class="summary-card glass dv360">
        <div class="card-header">
          <h3>DV360</h3>
          <span class="status-badge">Live</span>
        </div>
        <div class="card-metrics" id="dv360-metrics">
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Budget</span>
          </div>
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Spent</span>
          </div>
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Pacing</span>
          </div>
        </div>
      </div>
      
      <div class="summary-card glass amazon">
        <div class="card-header">
          <h3>Amazon</h3>
          <span class="status-badge">Live</span>
        </div>
        <div class="card-metrics" id="amazon-metrics">
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Budget</span>
          </div>
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Spent</span>
          </div>
          <div class="metric">
            <span class="metric-value">--</span>
            <span class="metric-label">Pacing</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Pacing Alerts -->
    <section class="alerts-section">
      <h3>âš ï¸ Pacing Alerts</h3>
      <div class="alerts-list" id="pacing-alerts">
        <p class="loading">Loading alerts...</p>
      </div>
    </section>

    <!-- Campaigns by Status -->
    <section class="campaigns-overview">
      <h3>Campaign Overview</h3>
      <div class="overview-grid">
        <div class="overview-item glass">
          <span class="overview-value" id="live-count">--</span>
          <span class="overview-label">Live</span>
        </div>
        <div class="overview-item glass">
          <span class="overview-value" id="paused-count">--</span>
          <span class="overview-label">Paused</span>
        </div>
        <div class="overview-item glass">
          <span class="overview-value" id="scheduled-count">--</span>
          <span class="overview-label">Scheduled</span>
        </div>
        <div class="overview-item glass">
          <span class="overview-value" id="draft-count">--</span>
          <span class="overview-label">Draft</span>
        </div>
      </div>
    </section>

    <!-- Recent Activity -->
    <section class="activity-section">
      <h3>ğŸ“‹ Recent Campaigns</h3>
      <div class="activity-list" id="recent-campaigns">
        <p class="loading">Loading campaigns...</p>
      </div>
    </section>
  </main>

  <script src="assets/app.js"></script>
  <script>
    async function loadDashboard() {
      try {
        // Load pacing data
        const pacingData = await fetch('/api/pacing').then(r => r.json());
        
        // Aggregate by DSP
        const byDSP = {};
        for (const p of pacingData.pacing || []) {
          if (!byDSP[p.dsp]) {
            byDSP[p.dsp] = { budget: 0, spent: 0, campaigns: [] };
          }
          byDSP[p.dsp].budget += p.budget;
          byDSP[p.dsp].spent += p.spent;
          byDSP[p.dsp].campaigns.push(p);
        }
        
        // Update DSP cards
        for (const [dsp, data] of Object.entries(byDSP)) {
          const elementId = dsp === 'amazon-dsp' ? 'amazon-metrics' : `${dsp}-metrics`;
          const element = document.getElementById(elementId);
          if (element) {
            const pacing = data.budget > 0 ? ((data.spent / data.budget) * 100).toFixed(0) : 0;
            element.innerHTML = `
              <div class="metric">
                <span class="metric-value">$${(data.budget/1000).toFixed(0)}K</span>
                <span class="metric-label">Budget</span>
              </div>
              <div class="metric">
                <span class="metric-value">$${(data.spent/1000).toFixed(0)}K</span>
                <span class="metric-label">Spent</span>
              </div>
              <div class="metric">
                <span class="metric-value">${pacing}%</span>
                <span class="metric-label">Pacing</span>
              </div>
            `;
          }
        }
        
        // Show pacing alerts
        const alerts = (pacingData.pacing || []).filter(p => 
          p.status && p.status.includes('critical')
        );
        
        const alertsEl = document.getElementById('pacing-alerts');
        if (alerts.length > 0) {
          alertsEl.innerHTML = alerts.map(a => `
            <div class="alert-item ${a.status}">
              <span class="alert-campaign">${a.campaignName}</span>
              <span class="alert-detail">${a.variance}% ${a.status.includes('behind') ? 'behind' : 'ahead'}</span>
              <span class="alert-dsp">${a.dsp.toUpperCase()}</span>
            </div>
          `).join('');
        } else {
          alertsEl.innerHTML = '<p class="success">âœ… All campaigns pacing normally</p>';
        }
        
        // Load campaigns
        const campaigns = await fetch('/api/campaigns').then(r => r.json());
        
        // Update counts
        const statusCounts = { live: 0, paused: 0, scheduled: 0, draft: 0 };
        campaigns.forEach(c => {
          if (statusCounts[c.status] !== undefined) {
            statusCounts[c.status]++;
          }
        });
        
        document.getElementById('live-count').textContent = statusCounts.live;
        document.getElementById('paused-count').textContent = statusCounts.paused;
        document.getElementById('scheduled-count').textContent = statusCounts.scheduled;
        document.getElementById('draft-count').textContent = statusCounts.draft;
        
        // Show recent campaigns
        const recent = campaigns.slice(0, 5);
        document.getElementById('recent-campaigns').innerHTML = recent.map(c => `
          <div class="campaign-item glass">
            <div class="campaign-info">
              <span class="campaign-name">${c.name}</span>
              <span class="campaign-meta">${c.dsp} â€¢ ${c.channel || 'Display'} â€¢ ${c.lob || 'General'}</span>
            </div>
            <div class="campaign-status">
              <span class="status-badge ${c.status}">${c.status}</span>
              <span class="campaign-budget">$${((c.spent || 0)/1000).toFixed(1)}K / $${((c.budget || 0)/1000).toFixed(0)}K</span>
            </div>
          </div>
        `).join('');
        
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }
    
    loadDashboard();
    // Refresh every 30 seconds
    setInterval(loadDashboard, 30000);
  </script>
</body>
</html>
