<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Query - Digital Advertising Command</title>
  <link rel="stylesheet" href="assets/styles.css">

  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/loading.css">
  <link rel="stylesheet" href="/css/animations.css">
</head>
<body>

  <!-- Hamburger Menu (Mobile) -->
  <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Toggle menu">
    <div class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </button>
  
  <!-- Sidebar Overlay (Mobile) -->
  <div class="sidebar-overlay" onclick="closeSidebar()"></div>
  <nav class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ¯ Digital Ad</h1>
      <span class="subtitle">Command Center</span>
    </div>
    <ul class="nav-links">
      <li><a href="/dashboard" class="nav-link">ğŸ“ˆ Dashboard</a></li>
      <li><a href="/campaigns" class="nav-link">ğŸ“‹ Campaigns</a></li>
      <li><a href="/insights" class="nav-link">ğŸ’¡ Insights</a></li>
      <li><a href="/agents" class="nav-link">ğŸ¤– Agents</a></li>
      <li><a href="/query" class="nav-link active">ğŸ’¬ Query</a></li>
      <li><a href="/architecture" class="nav-link">ğŸ—ï¸ Architecture</a></li>
      <li><a href="/connectors" class="nav-link">ğŸ”Œ Connectors</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <header class="page-header">
      <h2>ğŸ’¬ Natural Language Query</h2>
      <p>Ask anything about your campaigns</p>
    </header>

    <!-- Query Input -->
    <section class="query-section glass">
      <div class="query-input-container">
        <input type="text" id="query-input" placeholder="Ask a question... (e.g., 'What campaigns are behind pacing?')" />
        <button id="submit-query" class="btn primary">Ask</button>
      </div>
      <div class="query-suggestions">
        <span class="suggestion" onclick="setQuery('What is the pacing status?')">Pacing status</span>
        <span class="suggestion" onclick="setQuery('Which campaigns need optimization?')">Optimization needed</span>
        <span class="suggestion" onclick="setQuery('Show me the WoW performance')">WoW performance</span>
        <span class="suggestion" onclick="setQuery('What are the display specs?')">Display specs</span>
        <span class="suggestion" onclick="setQuery('Check brand safety')">Brand safety</span>
      </div>
    </section>

    <!-- Response -->
    <section class="response-section" id="response-section" style="display: none;">
      <div class="response-header">
        <span id="response-agent">ğŸ¤– Agent</span>
        <span id="response-time"></span>
      </div>
      <div class="response-content glass" id="response-content"></div>
    </section>

    <!-- History -->
    <section class="history-section">
      <h3>Recent Queries</h3>
      <div class="history-list" id="history-list">
        <p class="empty">No queries yet</p>
      </div>
    </section>
  </main>

  <script src="assets/app.js"></script>
  <script>
    const queryHistory = [];
    
    const agentIcons = {
      'media-planner': 'ğŸ“ˆ',
      'trader': 'ğŸ’¹',
      'analyst': 'ğŸ“Š',
      'creative-ops': 'ğŸ¨',
      'compliance': 'ğŸ›¡ï¸'
    };
    
    function setQuery(text) {
      document.getElementById('query-input').value = text;
    }
    
    async function submitQuery() {
      const queryInput = document.getElementById('query-input');
      const query = queryInput.value.trim();
      
      if (!query) return;
      
      const responseSection = document.getElementById('response-section');
      const responseContent = document.getElementById('response-content');
      const responseAgent = document.getElementById('response-agent');
      const responseTime = document.getElementById('response-time');
      
      responseSection.style.display = 'block';
      responseContent.innerHTML = '<p class="loading">Thinking...</p>';
      
      const startTime = Date.now();
      
      try {
        const result = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        }).then(r => r.json());
        
        const elapsed = Date.now() - startTime;
        
        responseAgent.innerHTML = `${agentIcons[result.agent] || 'ğŸ¤–'} ${result.agentName || result.agent}`;
        responseTime.textContent = `${elapsed}ms`;
        
        // Format result
        if (typeof result.result === 'string') {
          responseContent.innerHTML = `<p>${result.result}</p>`;
        } else {
          responseContent.innerHTML = `<pre>${JSON.stringify(result.result, null, 2)}</pre>`;
        }
        
        // Add to history
        queryHistory.unshift({
          query,
          agent: result.agent,
          time: new Date().toLocaleTimeString()
        });
        
        updateHistory();
        
      } catch (err) {
        responseContent.innerHTML = `<p class="error">Error: ${err.message}</p>`;
      }
    }
    
    function updateHistory() {
      const historyList = document.getElementById('history-list');
      
      if (queryHistory.length === 0) {
        historyList.innerHTML = '<p class="empty">No queries yet</p>';
        return;
      }
      
      historyList.innerHTML = queryHistory.slice(0, 10).map(h => `
        <div class="history-item" onclick="setQuery('${h.query.replace(/'/g, "\\'")}')">
          <span class="history-query">${h.query}</span>
          <span class="history-meta">${agentIcons[h.agent] || 'ğŸ¤–'} ${h.time}</span>
        </div>
      `).join('');
    }
    
    // Event listeners
    document.getElementById('submit-query').addEventListener('click', submitQuery);
    document.getElementById('query-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') submitQuery();
    });
  </script>

  <script src="/components/loading.js"></script>
  <script src="/components/errors.js"></script>
  <script src="/components/navigation.js"></script>

  <script>
    // Sidebar toggle for mobile
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const hamburger = document.querySelector('.hamburger-btn');
      const overlay = document.querySelector('.sidebar-overlay');
      
      sidebar.classList.toggle('open');
      hamburger.classList.toggle('open');
      overlay.classList.toggle('active');
    }
    
    function closeSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const hamburger = document.querySelector('.hamburger-btn');
      const overlay = document.querySelector('.sidebar-overlay');
      
      sidebar.classList.remove('open');
      hamburger.classList.remove('open');
      overlay.classList.remove('active');
    }
    
    // Close sidebar on navigation
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
      link.addEventListener('click', closeSidebar);
    });
  </script>
</body>
</html>
